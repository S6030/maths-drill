<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Math Drill</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f9fc; color: #333; text-align: center; padding: 20px; }
    #setup, #quiz, #summary { max-width: 360px; margin: 20px auto; background: #fff;
      border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 16px; }
    .options-group { margin: 12px 0; text-align: left; }
    .options-group .grid {
      display: grid; grid-template-columns: repeat(5, auto); gap: 6px;
      max-height: 80px; overflow-y: auto; padding: 4px;
      border: 1px solid #ddd; border-radius: 4px; background: #fafafa;
    }
    .options-group label { cursor: pointer; font-size: 14px; }
    select, .btn { font-size: 16px; }
    .btn {
      padding: 8px 16px; background: #4a90e2; color: #fff;
      border: none; border-radius: 4px; cursor: pointer; margin: 8px 4px;
    }
    .btn:hover { background: #357ab8; }
    #question { font-size: 28px; margin: 16px 0; }
    #answer {
      font-size: 22px; width: 120px; text-align: center; padding: 8px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    #feedback { font-size: 26px; width: 100px; display: inline-block; vertical-align: middle; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px;
    }
    th, td { border: 1px solid #ddd; padding: 6px; }
    th { background: #f0f4f8; }
  </style>
</head>
<body>

  <div id="setup">
    <h2>Math Drill</h2>
    <p>Select mode and subject, then Start (or Finish Now):</p>

    <div class="options-group">
      <strong>Mode:</strong>
      <select id="mode-select">
        <option value="fixed">Fixed (30 Q)</option>
        <option value="intelligent">Intelligent (30 eval + 50 targeted)</option>
      </select>
    </div>

    <div class="options-group">
      <strong>Subject:</strong>
      <select id="subject-select">
        <option value="tables">Multiplication Tables</option>
        <option value="squares">Squares 1²–20²</option>
        <option value="primes">Prime Tables (first 20 primes)</option>
      </select>
    </div>

    <div id="tables-options" class="options-group">
      <strong>Tables 1–20:</strong>
      <div class="grid" id="table-grid"></div>
    </div>

    <button id="start-btn" class="btn">Start</button>
    <button id="finish-btn" class="btn">Finish Now</button>
  </div>

  <div id="quiz" style="display:none">
    <div id="question"></div>
    <input id="answer" autocomplete="off" placeholder="Answer">
    <span id="feedback"></span>
  </div>

  <div id="summary" style="display:none">
    <h2>Results</h2>
    <p id="score"></p>
    <p id="grade"></p>
    <h3>All Mistakes</h3>
    <table>
      <thead><tr><th>Problem</th><th>You wrote</th><th>Correct</th></tr></thead>
      <tbody id="mistakes-body"></tbody>
    </table>
    <button id="restart-btn" class="btn">Restart</button>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const TOTAL_FIXED = 30,
        EVAL_COUNT  = 30,
        TRAIN_COUNT = 50,
        primeList   = [2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71];

  // UI references
  const modeSelect    = document.getElementById('mode-select'),
        subjectSelect = document.getElementById('subject-select'),
        tableGrid     = document.getElementById('table-grid'),
        tablesOpts    = document.getElementById('tables-options'),
        startBtn      = document.getElementById('start-btn'),
        finishBtn     = document.getElementById('finish-btn'),
        setup         = document.getElementById('setup'),
        quiz          = document.getElementById('quiz'),
        questionEl    = document.getElementById('question'),
        answerEl      = document.getElementById('answer'),
        feedbackEl    = document.getElementById('feedback'),
        summary       = document.getElementById('summary'),
        scoreEl       = document.getElementById('score'),
        gradeEl       = document.getElementById('grade'),
        mistakesBody  = document.getElementById('mistakes-body'),
        restartBtn    = document.getElementById('restart-btn');

  // State
  let pool = [], evalQ = [], trainQ = [];
  let errors = {}, mistakes = [], times = {}, current = null;
  let qCount = 0, correctCount = 0, startTime = 0;

  // Build table checkboxes grid
  function buildTableGrid(){
    tableGrid.innerHTML = '';
    for(let n=1; n<=20; n++){
      const lbl = document.createElement('label');
      lbl.innerHTML = `<input type="checkbox" value="${n}" checked> ${n}`;
      tableGrid.appendChild(lbl);
    }
  }
  buildTableGrid();

  // Show/hide tables options
  subjectSelect.onchange = () => {
    tablesOpts.style.display = (subjectSelect.value === 'tables') ? '' : 'none';
  };
  subjectSelect.dispatchEvent(new Event('change'));

  // Utility functions
  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1)) + a; }
  function shuffle(arr){
    for(let i=arr.length-1; i>0; i--){
      const j = randInt(0,i);
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }
  function weightedPick(arr){
    let totalW = 0;
    arr.forEach(q => totalW += (errors[q.key]||0) + 1);
    let r = Math.random() * totalW;
    for(const q of arr){
      r -= (errors[q.key]||0) + 1;
      if(r <= 0) return q;
    }
    return arr[arr.length-1];
  }

  // Build the pool of problems
  function makePool(){
    pool = [];
    const subj = subjectSelect.value;
    if(subj === 'tables'){
      const sel = Array.from(tableGrid.querySelectorAll('input:checked'))
                       .map(cb => +cb.value);
      if(!sel.length) sel.push(...Array.from({length:20},(_,i)=>i+1));
      sel.forEach(a => {
        for(let b=1; b<=20; b++){
          pool.push({ key: `${a}x${b}`, correct: a*b });
        }
      });
    }
    else if(subj === 'squares'){
      for(let n=1; n<=20; n++){
        pool.push({ key: `${n}^2`, correct: n*n });
      }
    }
    else { // primes
      primeList.forEach(p => {
        for(let b=1; b<=20; b++){
          pool.push({ key: `${p}x${b}`, correct: p*b });
        }
      });
    }
    shuffle(pool);
  }

  // Start the drill
  function startDrill(){
    const mode = modeSelect.value;
    makePool();

    const firstCount = (mode === 'fixed') ? TOTAL_FIXED : EVAL_COUNT;
    evalQ = [];
    let idx = 0;
    while(evalQ.length < firstCount){
      if(idx >= pool.length) idx = 0;
      evalQ.push(pool[idx++]);
    }
    shuffle(evalQ);
    trainQ = [];
    errors = {}; mistakes = []; times = {};
    qCount = 0; correctCount = 0;

    setup.style.display = 'none';
    summary.style.display = 'none';
    quiz.style.display = '';
    nextQuestion();
  }

  // Next question
  function nextQuestion(){
    const mode = modeSelect.value;
    const maxQ = (mode === 'fixed') ? TOTAL_FIXED : (EVAL_COUNT + TRAIN_COUNT);
    if(qCount >= maxQ) {
      return finishDrill();
    }

    if(evalQ.length){
      current = evalQ.pop();
    }
    else if(mode === 'intelligent' && Object.keys(errors).length){
      if(!trainQ.length){
        const topKeys = Object.entries(errors)
                              .sort((a,b)=>b[1]-a[1])
                              .slice(0, TRAIN_COUNT)
                              .map(([k])=>k);
        trainQ = topKeys.map(k=>{
          let correct = 0;
          if(k.includes('^2')){
            const n = Number(k.replace('^2',''));
            correct = n*n;
          } else {
            const [a,b] = k.split('x').map(Number);
            correct = a*b;
          }
          return { key: k, correct };
        });
      }
      if(trainQ.length){
        current = weightedPick(trainQ);
        trainQ = trainQ.filter(q => q.key !== current.key);
      } else {
        return finishDrill();
      }
    }
    else {
      return finishDrill();
    }

    // Display, converting key back to nice chars
    questionEl.textContent = current.key
      .replace(/x/g, '×')
      .replace(/\^2/g, '²');
    answerEl.value = '';
    feedbackEl.textContent = '';
    answerEl.focus();
    startTime = performance.now();
  }

  // Handle input
  answerEl.addEventListener('input', ()=>{
    const v = answerEl.value.trim();
    if(!/^\d+$/.test(v)) return;
    if(v.length === String(current.correct).length){
      const dt = ((performance.now() - startTime)/1000).toFixed(2);
      times[current.key] = times[current.key] || [];
      times[current.key].push(+dt);

      qCount++;
      if(Number(v) === current.correct){
        feedbackEl.textContent = '✔';
        feedbackEl.style.color = 'green';
        correctCount++;
      } else {
        feedbackEl.textContent = `✖ ${current.correct}`;
        feedbackEl.style.color = 'red';
        errors[current.key] = (errors[current.key]||0) + 1;
        mistakes.push({ key: current.key, given: +v, correct: current.correct });
      }
      setTimeout(nextQuestion, 500);
    }
  });

  // Finish early
  finishBtn.addEventListener('click', finishDrill);

  // Show results
  function finishDrill(){
    quiz.style.display = 'none';
    summary.style.display = '';

    const mode = modeSelect.value;
    const totalQ = (mode === 'fixed') ? TOTAL_FIXED : (EVAL_COUNT + TRAIN_COUNT);
    scoreEl.textContent = `Score: ${correctCount}/${totalQ}`;
    const grade = Math.round(correctCount/totalQ*10),
          face  = grade >= 8 ? '😊' : grade >= 5 ? '😐' : '😞';
    gradeEl.textContent = `Grade: ${grade}/10 ${face}`;

    mistakesBody.innerHTML = '';
    mistakes.forEach(m => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${m.key.replace(/x/g,'×').replace(/\^2/g,'²')}</td>` +
                     `<td>${m.given}</td><td>${m.correct}</td>`;
      mistakesBody.appendChild(tr);
    });
  }

  // Start / Restart handlers
  startBtn.addEventListener('click', ()=>{
    startBtn.disabled = true;
    startDrill();
  });
  restartBtn.addEventListener('click', ()=>{
    startBtn.disabled = false;
    setup.style.display = '';
    summary.style.display = 'none';
  });

});
</script>
</body>
</html>

